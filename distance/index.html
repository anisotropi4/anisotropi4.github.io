<!DOCTYPE html>
<html>
    <head>
        <title>Population Density and Distance from a Railway Station in Great Britain</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
        <link rel="stylesheet" href="//azavea.github.io/Leaflet.zoomdisplay/css/leaflet.zoomdisplay.css"/>
    </head>
    <style>
     .legend {
         text-align: left;
         line-height: 20px;
         background: white;
         opacity: 1;
         padding: 8px;
         bottom-margin: 20px;
     }
     .legend i {
         width: 16px;
         height: 16px;
         float: left;
         margin-right: 8px;
         opacity: 1;
     }
     .legend square {
         border-radius: 50%;
         width: 5px;
         height: 5px;
         margin-top: 2px;
     }
    </style>
    <body style='margin:0'>
        <div id="map" style="width: 100vw; height: 100vh; background: PowderBlue"></div>
        <script type="text/javascript"  src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
        <script type="text/javascript"  src="https://unpkg.com/leaflet.vectorgrid@1.3.0"></script>
        <script src="//azavea.github.io/Leaflet.zoomdisplay/js/leaflet.zoomdisplay.js"></script>
        <script>
         const minZoom = 5;
         const maxZoom = 14;
         const nGroup = [0.0, 5000.0, 10000.0, 32000.0];
         var map = L.map('map', {
             minZoom: minZoom,
             maxZoom: maxZoom,
             zoomControl: false,
         }).setView([55.53, -4.53], 6);
         function get_ncolor(v) {
             for (var i = nGroup.length - 1; i > 0; i--) {
                 if (v >= nGroup[i]) return i
             }
             return 0;
         };
         function get_color(v, n=4) {
             const orange = {4: ["#fff2e6", "#ffcc99", "#ffa54c", "#ff7900"],
                             5: ["#fff2e6", "#ffd6ad", "#ffb973", "#ff9c39", "#ff7900"],
                             8: ["#fff2e6", "#ffe2c5", "#ffd1a4", "#ffc183", "#ffb062", "#ffa041", "#ff8f20", "#ff7900"]};
             return orange[n][get_ncolor(v)];
         };
         var legend = L.control({position: 'bottomleft'});
         legend.onAdd = function (map) {
             var div = L.DomUtil.create('div', 'info legend');
             var labels = ['<strong>Distance [km]</strong>'];
             const n = nGroup.length;
             const sGroup = nGroup.map(function (v) { return v / 1000.0 });
             for (var i = 0; i < sGroup.length; i++) {
                 var s = ("   " + sGroup[i]).slice(-3).replace(" ", "&nbsp;");
                 var t = ((i + 1) < sGroup.length) ? '&ndash;' + sGroup[i+1] : '+';
                 labels.push('<i class="square" style="background:' + get_color(nGroup[i]) + '"></i> ' + s + t + "km");
             }
             div.innerHTML = labels.join('<br>');
             return div;
         };
         legend.addTo(map);
         var vectorTileStyling = {
             density: function (properties, zoom) {
                 var distance = properties.distance;
                 var color = get_color(distance);
                 return ({fill: true,
                          weight: 1.0,
                          fillColor: color,
                          color: color,
                          fillOpacity: 1.0,
                          opacity: 1.0,
                          zIndex: 1,
                 });
             },
             station: {
                 radius: 1.0,
                 color: "blue",
                 zIndex: 3,
             },
         };
         var mapUrl = "tiles/{z}/{x}/{y}.pbf";
         var mapVectorTileOptions = {
             rendererFactory: L.canvas.tile,
             interactive: true,
             attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ONS and National Records Scotland<a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"> Open Government License</a>',
             maxNativeZoom: maxZoom,
             minZoom: minZoom,
             vectorTileLayerStyles: vectorTileStyling,
         }
         var mapPbfLayer = L.vectorGrid.protobuf(mapUrl, mapVectorTileOptions).addTo(map);
         var mapVectorTileOptions = {
             rendererFactory: L.canvas.tile,
             interactive: true,
             attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy;',
             maxNativeZoom: maxZoom, // minZoom must be higher than minNativeZoom
             minZoom: minZoom,
             vectorTileLayerStyles: vectorTileStyling,
         }
         mapPbfLayer.bindPopup(function (layer) {
             const lookup = {
                 "OA11CD": "OA11 code",
                 "region_name": "Region",
                 "lsoa_code": "LSOA",
                 "msoa_code": "MSOA",
                 "population": "population",
                 "Area": "area",
                 "distance": "station distance",
                 "Station": "station name",
             };
             var p = layer.properties;
             var popupContent = "<b>" + p.Town + "</b>";
             p.Area = Math.round(p.Area);
             for (var [k, v] of Object.entries(p)) {
                 if (k == 'Area') v = Math.round(v / 100.0) / 100.0 + ' Ha';
                 if (k == 'distance') v = Math.round(v / 100.0) / 10.0 + ' km';
                 if (k in lookup) popupContent += "<br>" + lookup[k] + ": " + v;
             }
             return popupContent;
         });
         var zoomcontrol = new L.Control.Zoom({ position: 'bottomright' }).addTo(map)
        </script>
    </body>
</html>
